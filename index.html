<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡ç½®å¯†ç  - MoodBox</title>
    <style>
        body {
          font-family: Arial, sans-serif;
          text-align: center;
          padding: 50px;
          background: #F6EEE2;
        }
        .container {
          background: white;
          padding: 40px;
          border-radius: 10px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          max-width: 500px;
          margin: 0 auto;
        }
        h1 { color: #1F2937; }
        label { display: block; margin-top: 20px; font-weight: bold; text-align: left; }
        input {
          width: 100%;
          padding: 12px;
          margin-top: 5px;
          border-radius: 6px;
          border: 1px solid #ccc;
          font-size: 16px;
        }
        .button {
          background: #F09D00;
          color: white;
          padding: 14px 28px;
          text-decoration: none;
          border-radius: 8px;
          font-weight: bold;
          margin-top: 30px;
          display: inline-block;
          cursor: pointer;
          border: none;
        }
        .message {
          margin-top: 20px;
          font-size: 16px;
        }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>

<div class="container">
    <h1>é‡ç½®å¯†ç </h1>
    <p>è¯·è¾“å…¥æ–°å¯†ç å®Œæˆå¯†ç é‡ç½®</p>

    <label for="newPassword">æ–°å¯†ç </label>
    <input type="password" id="newPassword" placeholder="è¾“å…¥æ–°å¯†ç ">

    <button class="button" onclick="resetPassword()">æäº¤</button>

    <div class="message" id="message"></div>
</div>

<!-- å¼•å…¥ Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // é…ç½®å¸¸é‡
    const SUPABASE_URL = 'https://bwbohtprwnegbunrxnyj.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3Ym9odHByd25lZ2J1bnJ4bnlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwODY5NjYsImV4cCI6MjA3OTY2Mjk2Nn0.VRek3BsAz0DcGPJDbq3HbDYwSqh4Wj2wU7HPCLBioX4';

    // å…³é”®ä¿®å¤ï¼šä½¿ç”¨ window.supabase æ¥è®¿é—®åº“ï¼Œæˆ–è€…ç”¨ä¸åŒçš„å˜é‡å
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function resetPassword() {
        const newPassword = document.getElementById('newPassword').value;
        const messageEl = document.getElementById('message');
        messageEl.textContent = '';
        messageEl.className = 'message';

        if (!newPassword || newPassword.length < 6) {
            messageEl.textContent = 'å¯†ç ä¸èƒ½å°‘äº6ä½å­—ç¬¦';
            messageEl.classList.add('error');
            return;
        }

        try {
            // 1. ä»URLè·å–ä¸€æ¬¡æ€§éªŒè¯ç 
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (!code) {
                throw new Error('é‡ç½®é“¾æ¥æ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç”³è¯·ã€‚');
            }

            // 2. ä½¿ç”¨éªŒè¯ç æ¢å–ä¼šè¯ (è¿™æ˜¯å…³é”®æ­¥éª¤)
            const { data: sessionData, error: sessionError } = await client.auth.exchangeCodeForSession(code);
            if (sessionError) throw sessionError;

            // 3. æ›´æ–°ç”¨æˆ·å¯†ç  (Supabase v2 API ä¸éœ€è¦æ˜¾å¼ä¼ é€’ access_token)
            const { data, error } = await client.auth.updateUser({
                password: newPassword
            });

            if (error) throw error;

            // 4. æˆåŠŸå¤„ç†
            messageEl.textContent = 'ğŸ‰ å¯†ç é‡ç½®æˆåŠŸï¼3ç§’åè·³è½¬åˆ°ç™»å½•é¡µ...';
            messageEl.classList.add('success');
            setTimeout(() => {
                window.location.href = 'login.html'; // è·³è½¬åˆ°ä½ çš„ç™»å½•é¡µ
            }, 3000);

        } catch (err) {
            console.error('å¯†ç é‡ç½®å¤±è´¥:', err);
            let userMessage = err.message;
            // æä¾›æ›´å‹å¥½çš„é”™è¯¯æç¤º
            if (err.message.includes('invalid')) {
                userMessage = 'é‡ç½®é“¾æ¥æ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç”³è¯·ã€‚';
            } else if (err.message.includes('rate limit')) {
                userMessage = 'æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•ã€‚';
            }
            messageEl.textContent = `é‡ç½®å¤±è´¥: ${userMessage}`;
            messageEl.classList.add('error');
        }
    }
</script>

</body>
</html>
